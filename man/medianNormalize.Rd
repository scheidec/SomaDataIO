% Generated by roxygen2: do not edit by hand
% Please edit documentation in R/medianNormalize.R
\name{medianNormalize}
\alias{medianNormalize}
\title{Perform Median Normalization}
\usage{
medianNormalize(
  adat,
  reference = NULL,
  ref_field = "SampleType",
  ref_value = c("QC", "Sample"),
  by = "SampleType",
  do_field = "SampleType",
  do_regexp = "QC|Sample",
  verbose = TRUE
)
}
\arguments{
\item{adat}{A \code{soma_adat} object created using \code{\link[=read_adat]{read_adat()}}, containing
RFU values that have been hybridization normalized and plate scaled.}

\item{reference}{Optional. Reference for median normalization. Can be:
\itemize{
\item \code{NULL} (default): Use internal reference from study samples
\item A \code{soma_adat} object: Extract reference from this ADAT
\item A file path (character): Read external reference from tab/comma-separated file
\item A data.frame: Use provided reference data directly
}
When providing an external reference file or data.frame it must contain:
\describe{
\item{Dilution}{Character column specifying the dilution group names
(e.g., "0_005", "0_5", "20"). These should match the dilution
groups present in the ADAT analyte data.}
\item{Reference}{Numeric column containing the reference median values
for each dilution group. These values will be used as the target
medians for normalization.}
\item{SeqId}{Optional character column. When included, SeqId-specific
reference values are used for more precise normalization. Values
must be in "10000-28" format, not "seq.10000.28" format.}
}}

\item{ref_field}{Character. Field used to select reference samples when
\code{reference = NULL}. Default is \code{"SampleType"}.}

\item{ref_value}{Character. Value(s) in \code{ref_field} to use as reference
when \code{reference = NULL}. Default is \code{c("QC", "Sample")}.}

\item{by}{Character vector. Grouping variable(s) for grouped median normalization.
Must be column name(s) in the ADAT. Use grouping when there are known changes
in total protein load due to analysis conditions (e.g., disease vs. control,
treatment vs. baseline). Normalization will be performed within each group
separately. Default is \code{"SampleType"}.}

\item{do_field}{Character. The field used to select samples for normalization
(others keep original values). Default is \code{"SampleType"}.}

\item{do_regexp}{Character. A regular expression pattern to select samples
from \code{do_field} for normalization. Default is \code{"QC|Sample"}.}

\item{verbose}{Logical. Should progress messages be printed? Default is \code{TRUE}.}
}
\value{
A \code{soma_adat} object with median normalization applied and RFU values
adjusted. The existing \verb{NormScale_*} columns are updated to include the
effects of both plate scale normalization and median normalization.
}
\description{
Performs median normalization on a \code{soma_adat} object that has
already undergone hybridization normalization and contains plate scale
normalization factors.

Median normalization is a technique used to adjust data sets to remove
certain assay artifacts and biases prior to analysis, particularly those that
may arise due to differences in overall protein concentration, pipetting
errors, reagent concentration changes, assay timing, and other systematic
variabilities. Median normalization can improve assay precision and reduce
technical variations that can mask true biological signals.

This function works by calculating or using reference median values for each
dilution group present in the ADAT. Dilution groups are determined from the
analyte metadata and represent different sample dilutions used in the assay
(e.g., 1:1, 1:200, 1:2000). For each sample, the median RFU across all
analytes within a dilution group is calculated and compared to the reference
median for that group. Scale factors are then computed and applied to adjust
each sample's values toward the reference, ensuring consistent signal levels
across samples within each dilution group. This function supports multiple
reference approaches: calculating an internal reference from study samples,
or using a calculated reference from a different ADAT or external reference
file.
}
\section{Important Considerations}{

\itemize{
\item If there is a known change in total protein concentration due to analysis
conditions, perform normalization \emph{within} groups using the \code{by} parameter
\item In newer SomaScan assay versions, population references improve
inter-plate consistency compared to within-plate references
}
}

\examples{
\dontrun{
# Internal reference from study samples (default)
# Use when you have representative QC or control samples in your study
med_norm_adat <- medianNormalize(adat)

# Reference from specific samples in the ADAT
# Use when you want to normalize against only QC samples
med_norm_adat <- medianNormalize(adat,
                                 ref_field = "SampleType",
                                 ref_value = "QC")

# Reference from another ADAT
# Use when you have a reference population or control study
ref_adat <- read_adat("reference_file.adat")
med_norm_adat <- medianNormalize(adat, reference = ref_adat)

# External reference file
# Use when you have pre-calculated reference medians for each dilution
med_norm_adat <- medianNormalize(adat, reference = "reference_file.csv")

# External reference as data.frame
# Use for programmatic control over reference values
ref_data <- data.frame(
  Dilution = c("0_005", "0_5", "20"),
  Reference = c(1500.2, 3200.8, 4100.5)
)
med_norm_adat <- medianNormalize(adat, reference = ref_data)

# Custom grouping by multiple variables
# Use when total protein load changes due to analysis conditions
# (normalize within groups to account for expected biological differences)
med_norm_adat <- medianNormalize(adat, by = c("Sex", "SampleType"))

# Normalize only specific sample types
# Use when you want to preserve original values for certain sample types
med_norm_adat <- medianNormalize(adat,
                                 do_field = "SampleType",
                                 do_regexp = "Sample")
}
}
